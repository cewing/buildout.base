################################################################################
# Sets up a simple HTTP server to serve the documentation,
# generated by Sphinx. 
#
# Monitors source files and regenerates HTML as things change.
#
# See ../../cfg/settings.cfg for the HTTP port (currently 8889)
# 
################################################################################

[buildout]
include-site-packages = false
exec-sitecustomize = false

extends =
    ../../cfg/settings.cfg

parts = 
    python
    sphinx
    watchdog
    supervisor-conf
    supervisor
    generate-docs
    
################################################################################
#
# Set up the sphinx documentation processor.
#
[sphinx]
recipe = zc.recipe.egg
dependent-scripts = true
eggs =
    Sphinx
    cloud_sptheme

################################################################################
#
# Run a shell command to generate the docs.
#
[generate-docs]
recipe = cp.recipe.cmd
install_cmd = 
    BUILDDIR="${buildout:directory}/www"
    SPHINXBUILD="${buildout:directory}/bin/sphinx-build"
    SOURCEDIR="${buildout:directory}/docs"
    echo "Generating html documentation..."
    make -f $SOURCEDIR/Makefile html "BUILDDIR=$BUILDDIR" "SPHINXBUILD=$SPHINXBUILD" "SOURCEDIR=$SOURCEDIR"
    echo
update_cmd = ${:install_cmd}

################################################################################
#
# Set up watchdog to monitor the documentation source
# and re-generate as needed (see templates/supervisor/etc/supervisor.conf.in)
#
[watchdog]
recipe = zc.recipe.egg
dependent-scripts = true
eggs = 
    watchdog

################################################################################
#
# Install a local supervisord
#
[supervisor]
recipe = zc.recipe.egg
eggs = 
    supervisor

################################################################################
#
# Configure supervisor - includes all the necessary config files, as well
# as an example init.d script
#
[supervisor-conf]
recipe = z3c.recipe.filetemplate
source-directory = templates/supervisor

################################################################################
#
# Create a custom python interpeter - not strictly necessary, but useful for 
# debugging (used by the HTTP server run by supervisord)
#
[python]
recipe = tl.buildout_virtual_python
interpreter = python
eggs = 
    ${sphinx:eggs}
    ${supervisor:eggs}
    ${watchdog:eggs}
